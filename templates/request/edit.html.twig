{% extends 'base.html.twig' %}

{% block title %}{{ title }}{% endblock %}

{% block body %}
    {% set balanceRaw = paymentTotals.income|default(0) + paymentTotals.expense|default(0) %}
    {% set balanceClass = balanceRaw > 0 ? 'bg-success' : 'bg-danger' %}
    {% set balanceText = (balanceRaw / 100)|money_rub %}

    {{ form_start(form) }}
    {{ form_widget(form.name, {'attr': {'style': 'display: none', 'data-request-title-input': 'true'}}) }}
    <h1 class="h3 d-flex justify-content-start align-items-start gap-0 mb-3"><span id="requestTitle" class="d-inline-flex align-items-center gap-1" contenteditable="true" data-request-title="true">{{ requestEntity.name }}</span><i class="bi bi-pencil-square text-secondary" style="font-size: small"></i>&nbsp;<span id="requestBalance" class="badge {{ balanceClass }}">{{ balanceText }}</span>&nbsp;<span>{{ form_widget(form.status, {'attr': {'class': 'badge bg-primary dropdown-toggle'}}) }}</span></h1>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="">
                <h6 class="text-muted">Оборудование</h6>
                <div class="">{{ requestEntity.equipment.name }} <small class="text-muted">{% if requestEntity.equipment.city != '' or requestEntity.equipment.address != '' %} ({{ requestEntity.equipment.city }} {{ requestEntity.equipment.address }}) {% endif %}</small></div>
                <div class="">{{ requestEntity.equipment.mark }}</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="body">
                <h6 class="text-muted">Заказчик</h6>
                <div class="">{{ requestEntity.customer.name }}</div>
            </div>
        </div>
    </div>

    <div class="mb-4 d-flex align-items-center">
        <div id="prihod-rashod" class="d-grid mb-3">
            <div class="row">
                <div class="col-6" style="text-align: end;">
                    <h6 class="legend text-muted">Расход</h6>
                    <h1><b id="rashod" class="text-danger" data-payment-expense><span class="spinner-border" role="status" aria-hidden="true"></span></b></h1>
                </div>
                <div class="col-6 d-grid">
                    <h6 class="legend text-muted">Приход</h6>
                    <h1><b id="prihod" class="text-success" data-payment-income><span class="spinner-border" role="status" aria-hidden="true"></span></b></h1>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-6" style="text-align: end;">
                    <button type="button" class="btn btn-danger paymentEdit mb-3" data-bs-toggle="modal" data-bs-target="#modalPrihodRashod" data-request-id="{{ requestEntity.id }}" data-modal-name="Работа: расход" data-type="1" data-direction="0">Работа</button>
                    <button type="button" class="btn btn-danger paymentEdit" data-bs-toggle="modal" data-bs-target="#modalPrihodRashod" data-request-id="{{ requestEntity.id }}" data-modal-name="Накладные: расход" data-type="0" data-direction="0">Накл.</button>
                </div>
                <div class="col-6 d-grid">
                    <button type="button" class="btn btn-success paymentEdit mb-3" data-bs-toggle="modal" data-bs-target="#modalPrihodRashod" data-request-id="{{ requestEntity.id }}" data-modal-name="Работа: приход" data-type="1" data-direction="1">Работа</button>
                    <button type="button" class="btn btn-success paymentEdit" data-bs-toggle="modal" data-bs-target="#modalPrihodRashod" data-request-id="{{ requestEntity.id }}" data-modal-name="Накладные: приход" data-type="0" data-direction="1">Накл.</button>
                </div>
            </div>
        </div>
    </div>

    <div class="mb-3 col-md-5">
        <h6 class="text-muted">{{ form_label(form.notes) }}</h6>
        {{ form_widget(form.notes) }}
    </div>

    {{ form_end(form) }}

    <div class="clearfix">&nbsp;</div>
    <section id="history" class="mb-4">
        <h5>История</h5>
        <div class="row">
            <div class="col-12 col-lg-4">
                <div class="table-responsive">
                    <table id="paymentHistory" class="table table-sm align-middle mb-0" data-payment-history="true">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Дата</th>
                                <th scope="col" class="text-center" style="width: 160px;">Сумма</th>
                                <th scope="col">Статья</th>
                                <th scope="col" class="text-center" style="width: 80px;">Del</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% if payments is not empty %}
                            {% for payment in payments %}
                                <tr data-payment-row="{{ payment.id }}">
                                    <td>{{ payment.created ? payment.created|date('d.m.Y H:i') : '—' }}</td>
                                    <td class="text-center">
                                        <input
                                            type="number"
                                            pattern="-?[0-9]*"
                                            step="1"
                                            class="form-control form-control-sm text-end"
                                            name="payment_sum_{{ payment.id }}"
                                            value="{{ (payment.sum / 100)|number_format(0, '.', '') }}"
                                            data-payment-id="{{ payment.id }}"
                                            data-payment-sum-initial="{{ (payment.sum / 100)|number_format(0, '.', '') }}"
                                            data-payment-update-url="{{ path('payment_update_sum', {id: payment.id}) }}"
                                            data-payment-update-token="{{ csrf_token('payment_update_' ~ payment.id) }}"
                                        >
                                    </td>
                                    <td>
                                        {% set badgeClass = payment.sum > 0 ? 'bg-success' : 'bg-danger' %}
                                        <span
                                            class="badge {{ badgeClass }}"
                                            data-payment-badge="{{ payment.id }}"
                                        >
                                            {{ payment.note ?: payment.typeLabel }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <button
                                            type="button"
                                            class="btn btn-outline-danger btn-sm"
                                            data-payment-delete="{{ payment.id }}"
                                            data-payment-delete-token="{{ csrf_token('payment_delete_' ~ payment.id) }}"
                                            data-payment-delete-url="{{ path('payment_delete', {id: payment.id}) }}"
                                            title="Удалить"
                                        >
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr data-payment-empty="true">
                                <td colspan="4" class="text-center text-muted">Платежей пока нет</td>
                            </tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    {{ include('payment/modal.html.twig') }}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const formEl = document.querySelector('form');
            const titleEl = document.querySelector('#requestTitle');
            const titleInputEl = document.querySelector('[data-request-title-input="true"]');
            const statusEl = document.querySelector('#request_edit_status');
            const notesEl = document.querySelector('#request_edit_notes');

            const paymentExpenseEl = document.querySelector('[data-payment-expense]');
            const paymentIncomeEl = document.querySelector('[data-payment-income]');
            const paymentBalanceEl = document.querySelector('#requestBalance');
            const paymentHistoryBodyEl = document.querySelector('#paymentHistory tbody');
            const rashodEl = document.getElementById('rashod');
            const prihodEl = document.getElementById('prihod');

            const rubFormatter = new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', minimumFractionDigits: 0, maximumFractionDigits: 0 });

            // Recalculate income/expense from visible History table
            const recalcHistoryTotals = () => {
                if (!paymentHistoryBodyEl) return;
                let income = 0; // приход
                let expense = 0; // расход
                paymentHistoryBodyEl.querySelectorAll('input[name^="payment_sum_"]').forEach((input) => {
                    const raw = (input.value ?? '').trim();
                    if (raw === '') return;
                    const val = Number.parseInt(raw, 10);
                    if (!Number.isFinite(val)) return;
                    if (val > 0) {
                        income += val;
                    } else if (val < 0) {
                        expense += val; // keep negative
                    }
                });
                // Display in RUB without kopecks, assuming values are in RUB units (no cents)
                if (prihodEl) prihodEl.textContent = rubFormatter.format(income);
                if (rashodEl) rashodEl.textContent = rubFormatter.format(expense);
            };

            // Refresh History tbody from server to keep markup in sync
            const refreshHistoryFromServer = async () => {
                if (!paymentHistoryBodyEl) return false;
                try {
                    const response = await fetch(window.location.href, {
                        method: 'GET',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        cache: 'no-store',
                    });
                    if (!response.ok) return false;
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newTbody = doc.querySelector('#paymentHistory tbody');
                    if (!newTbody) return false;
                    paymentHistoryBodyEl.innerHTML = newTbody.innerHTML;
                    // Rebind handlers for new elements
                    paymentHistoryBodyEl.querySelectorAll('input[name^="payment_sum_"][data-payment-id]').forEach((input) => {
                        input.addEventListener('focus', handleSumFocus);
                        input.addEventListener('blur', handleSumBlur);
                    });
                    // Обработчики удаления уже назначены в основном коде
                    recalcHistoryTotals();
                    return true;
                } catch (_) {
                    return false;
                }
            };

            const updatePaymentTotals = (totals) => {
                if (!totals || typeof totals !== 'object') return;
                const incomeText = totals.income?.rub ?? null;
                if (paymentIncomeEl && typeof incomeText === 'string') paymentIncomeEl.textContent = incomeText;
                const expenseText = totals.expense?.rub ?? null;
                if (paymentExpenseEl && typeof expenseText === 'string') paymentExpenseEl.textContent = expenseText;
                if (paymentBalanceEl) {
                    const incomeRaw = Number(totals?.income?.raw ?? 0);
                    const expenseRaw = Number(totals?.expense?.raw ?? 0);
                    if (Number.isFinite(incomeRaw) && Number.isFinite(expenseRaw)) {
                        const balanceRaw = incomeRaw + expenseRaw;
                        paymentBalanceEl.textContent = rubFormatter.format(balanceRaw / 100);
                        const balanceClass = balanceRaw > 0 ? 'bg-success' : (balanceRaw < 0 ? 'bg-danger' : 'bg-secondary');
                        paymentBalanceEl.classList.add('badge');
                        paymentBalanceEl.classList.remove('bg-success', 'bg-danger', 'bg-secondary');
                        paymentBalanceEl.classList.add(balanceClass);
                    }
                }
            };

            const showToast = (message, type = 'success') => {
                const container = document.querySelector('.toast-container');
                if (!container) return;
                const toastEl = document.createElement('div');
                toastEl.className = `toast align-items-center text-bg-${type} border-0`;
                toastEl.role = 'alert';
                toastEl.ariaLive = 'assertive';
                toastEl.ariaAtomic = 'true';
                toastEl.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                `;
                container.appendChild(toastEl);
                const toastInstance = window.bootstrap?.Toast ? window.bootstrap.Toast.getOrCreateInstance(toastEl, { delay: 2500 }) : null;
                if (toastInstance) {
                    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
                    toastInstance.show();
                } else {
                    toastEl.classList.add('show');
                    setTimeout(() => toastEl.remove(), 2500);
                }
            };

            const postForm = async () => {
                if (!formEl) return false;
                const fd = new FormData(formEl);
                try {
                    const response = await fetch(formEl.action, {
                        method: 'POST',
                        body: fd,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    });
                    // Ignore response body; redirect will be followed silently
                    return response.ok;
                } catch (e) {
                    return false;
                }
            };

            // Title autosave
            if (titleEl && titleInputEl) {
                const syncTitleInput = () => { titleInputEl.value = (titleEl.textContent || '').trim(); };
                titleEl.addEventListener('input', syncTitleInput);
                titleEl.addEventListener('paste', (ev) => {
                    ev.preventDefault();
                    const text = (ev.clipboardData || window.clipboardData).getData('text');
                    document.execCommand('insertText', false, text.replace(/\s+/g, ' ').trim());
                    syncTitleInput();
                });
                titleEl.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') { ev.preventDefault(); titleEl.blur(); } });
                titleEl.addEventListener('blur', async () => { syncTitleInput(); const ok = await postForm(); if (ok) showToast('Сохранено'); });
            }

            // Status autosave
            if (statusEl) {
                statusEl.addEventListener('change', async () => { const ok = await postForm(); if (ok) showToast('Статус сохранён'); });
            }

            // Notes autosave
            if (notesEl) {
                notesEl.addEventListener('blur', async () => { const ok = await postForm(); if (ok) showToast('Заметки сохранены'); });
            }

            // Payments: sum update on blur
            const handleSumFocus = (event) => {
                const input = event.currentTarget;
                input.dataset.paymentSumInitial = (input.value ?? '').trim();
                input.dataset.paymentSumInitialRaw = (input.value ?? '').trim().replace(/[^\d.-]/g, '');
            };
            const handleSumBlur = async (event) => {
                const input = event.currentTarget;
                const initialValue = (input.dataset.paymentSumInitial ?? '').trim();
                const initialValueRaw = (input.dataset.paymentSumInitialRaw ?? '').trim();
                const currentValue = (input.value ?? '').trim();
                const currentValueRaw = (input.value ?? '').trim().replace(/[^\d.-]/g, '');
                if (currentValueRaw === initialValueRaw) return;
                const updateUrl = input.dataset.paymentUpdateUrl ?? '';
                const updateToken = input.dataset.paymentUpdateToken ?? '';
                if (!updateUrl || !updateToken) { input.value = initialValue; return; }
                input.disabled = true;
                try {
                    const response = await fetch(updateUrl, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                        body: JSON.stringify({ _token: updateToken, sum: currentValueRaw }),
                    });
                    if (!response.ok) throw new Error(await response.text());
                    const data = await response.json();
                    input.dataset.paymentSumInitial = currentValue;
                    input.dataset.paymentSumInitialRaw = currentValueRaw;
                    updatePaymentTotals(data?.totals ?? null);
                    recalcHistoryTotals();
                    const badgeSelectorId = input.dataset.paymentId ?? '';
                    if (badgeSelectorId !== '') {
                        const badgeEl = document.querySelector(`[data-payment-badge="${badgeSelectorId}"]`);
                        if (badgeEl && typeof data?.sum === 'number') {
                            const badgeClass = data.sum > 0 ? 'bg-success' : (data.sum < 0 ? 'bg-danger' : 'bg-secondary');
                            badgeEl.classList.remove('bg-success', 'bg-danger', 'bg-secondary');
                            badgeEl.classList.add(badgeClass);
                        }
                    }
                    showToast('Сумма обновлена');
                } catch (e) {
                    input.value = initialValue;
                } finally {
                    input.disabled = false;
                }
            };
            document.querySelectorAll('input[name^="payment_sum_"][data-payment-id]').forEach((input) => {
                input.addEventListener('focus', handleSumFocus);
                input.addEventListener('blur', handleSumBlur);
            });

            // Payments: delete
            document.querySelectorAll('[data-payment-delete][data-payment-delete-url]').forEach((button) => {
                button.addEventListener('click', async (event) => {
                    event.preventDefault();
                    const row = button.closest('tr');
                    const sumInput = row?.querySelector('input[data-payment-id]');
                    const sumValue = (sumInput?.value ?? '').trim();
                    if (!window.confirm(`Удалить платеж на ${sumValue} ₽?`)) return;
                    const url = button.dataset.paymentDeleteUrl ?? '';
                    const token = button.dataset.paymentDeleteToken ?? '';
                    if (!url || !token) return;
                    try {
                        const response = await fetch(url, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                            body: JSON.stringify({ _token: token }),
                        });
                        if (!response.ok) return;
                        const data = await response.json();
                        row?.remove();
                        updatePaymentTotals(data?.totals ?? null);
                        recalcHistoryTotals();
                        showToast('Платёж удалён');
                    } catch (e) { /* noop */ }
                });
            });

            const handlePaymentCreated = async (event) => {
                const data = event.detail ?? null;
                if (data?.totals) updatePaymentTotals(data.totals);
                const ok = await refreshHistoryFromServer();
                if (!ok) window.setTimeout(() => window.location.reload(), 0);
            };

            // Listen to payment creation from modal and prepend a new row
            const paymentModalRoot = document.getElementById('modalPrihodRashod');
            if (paymentModalRoot) {
                paymentModalRoot.addEventListener('payment:created', handlePaymentCreated);
            }

            // Observe table body changes (new rows from modal, etc.) and recalc
            if (paymentHistoryBodyEl && 'MutationObserver' in window) {
                const observer = new MutationObserver(() => recalcHistoryTotals());
                observer.observe(paymentHistoryBodyEl, { childList: true, subtree: false });
            }

            // Initial calculation on page load
            recalcHistoryTotals();
        });
    </script>
{% endblock %}